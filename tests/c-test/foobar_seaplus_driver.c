/*
 * C example Seaplus driver around the toy foobar library, giving access to its
 * API, i.e. to the functions declared in foobar.h (and defined on foobar.c).
 *
 * Directly inspired from:
 * http://erlang.org/doc/tutorial/erl_interface.html#c-program
 *
 */


// For the Erlang binding:
#include "seaplus.h"


// For the wrapped library code:
#include "foobar.h"


// For strncmp:
#include <string.h>

// For exit:
#include <stdlib.h>

typedef unsigned char byte ;


// Designates a function:
typedef unsigned int fun_id ;


// Typicallu generated by the Seaplus parse transform:
#include "foobar_seaplus_api_mapping.h"



int main()
{

  byte * buffer = start_driver() ;

  // Pointer to an ETERM representing a tuple:
  ETERM * paramTuple ;

  // To hold a Seaplus-defined function identifier (ex: FOO_1_ID):
  unsigned int funId ;

  // Reads a full command in buffer, based on its initial length:
  while ( read_command( buffer ) > 0 )
  {

	// Reads a { FunId, FunParams } pair:
	paramTuple = erl_decode( buffer ) ;

	/* Note that all parameters must be read (with a get_* function), otherwise
	 * their memory will be leaked.
	 *
	 */

	// Whose first element is the function identifier:
	funId = get_as_unsigned_int( 1, paramTuple ) ;

	LOG_DEBUG( "Reading command: function identifier is %u", funId ) ;

	switch( funId )
	{

	case FOO_1_ID:
	  // Second one is its (single, int) parameter:
	  write_as_int( buffer, paramTuple, foo( get_as_int( 2, paramTuple ) ) ) ;
	  break ;

	case BAR_2_ID:
	  // Second and third are its two int parameters:
	  write_as_int( buffer, paramTuple, bar( get_as_int( 2, paramTuple ),
										  get_as_int( 3, paramTuple ) ) ) ;
	  break ;

	case BAZ_2_ID:
	  // Second one is its (single, float) parameter:
	  write_as_string( buffer, paramTuple,
					   baz( (float) get_as_double( 2, paramTuple ) ) ) ;
	  break ;

	case TUR_0_ID:
	  // Second one is its (single, string) parameter:
	  write_as_unsigned_int( buffer, paramTuple,
							 tur( get_as_string( 2, paramTuple ) ) ) ;
	  break ;

	case FROB_1_ID:
	  // Second one is its (single, string) parameter:
	  write_as_binary( buffer, paramTuple,
					   frob( get_as_string( 2, paramTuple ) ) ) ;
	  break ;

	default:
	  LOG_ERROR( "Unknown function identifier: %u", funId ) ;
	  exit( 10 ) ;

	}

  }

  stop_driver( buffer ) ;

}
